<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramadan Porridge Distribution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        #reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        .number-btn {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .number-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .number-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="text-center">
                <h1 class="text-3xl md:text-4xl font-bold text-green-700 mb-2">
                    <i class="fas fa-moon mr-2"></i>Ramadan Porridge Distribution
                </h1>
                <p class="text-gray-600">Track and manage porridge distribution with QR codes</p>
            </div>
        </div>

        <!-- Scanner Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-qrcode mr-2"></i>Scan Membership QR Code
            </h2>
            
            <div class="mb-4">
                <button id="startScanBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                    <i class="fas fa-camera mr-2"></i>Start QR Code Scanner
                </button>
            </div>

            <div id="reader" class="hidden mb-4"></div>

            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">Membership Number:</label>
                <input type="text" id="membershipInput" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none text-lg"
                    placeholder="Scan QR code or enter manually">
            </div>

            <button id="manualSubmitBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                <i class="fas fa-check mr-2"></i>Submit Manually
            </button>
        </div>

        <!-- Export Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="exportBtn" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                    <i class="fas fa-file-excel mr-2"></i>Export to Excel
                </button>
                <button id="resetBtn" class="hidden flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                    <i class="fas fa-trash mr-2"></i>Reset All Data
                </button>
            </div>
        </div>

        <!-- Records Table -->
        <div class="bg-white rounded-lg shadow-lg p-4 md:p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-list mr-2"></i>Distribution Records (<span id="recordCount">0</span>)
            </h2>
            
            <!-- Desktop Table View -->
            <div class="hidden md:block overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-green-600 text-white">
                        <tr>
                            <th class="px-4 py-3 text-left rounded-tl-lg">#</th>
                            <th class="px-4 py-3 text-left">Membership No.</th>
                            <th class="px-4 py-3 text-left">Family Count</th>
                            <th class="px-4 py-3 text-left rounded-tr-lg">Time Issued</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTableDesktop" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                                <i class="fas fa-inbox text-4xl mb-2"></i>
                                <p>No records yet. Start scanning to add distributions.</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Mobile Card View -->
            <div id="recordsTableMobile" class="md:hidden space-y-3">
                <div class="text-center py-12 text-gray-500">
                    <i class="fas fa-inbox text-4xl mb-3"></i>
                    <p>No records yet. Start scanning to add distributions.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let html5QrCode = null;
        let isScanning = false;
        let records = [];

        // Load records from memory
        function loadRecords() {
            const saved = JSON.parse(localStorage.getItem('porridgeRecords') || '[]');
            records = saved;
            updateTable();
        }

        // Save records to memory
        function saveRecords() {
            localStorage.setItem('porridgeRecords', JSON.stringify(records));
        }

        // Format time
        function formatTime(date) {
            return new Date(date).toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // Update table display
        function updateTable() {
            const tbodyDesktop = document.getElementById('recordsTableDesktop');
            const mobileView = document.getElementById('recordsTableMobile');
            const countSpan = document.getElementById('recordCount');
            
            countSpan.textContent = records.length;

            if (records.length === 0) {
                // Desktop empty state
                tbodyDesktop.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-2"></i>
                            <p>No records yet. Start scanning to add distributions.</p>
                        </td>
                    </tr>
                `;
                
                // Mobile empty state
                mobileView.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-3"></i>
                        <p>No records yet. Start scanning to add distributions.</p>
                    </div>
                `;
                return;
            }

            // Desktop table view
            tbodyDesktop.innerHTML = records.map((record, index) => `
                <tr class="hover:bg-gray-50 transition duration-150">
                    <td class="px-4 py-3 font-semibold text-gray-700">${index + 1}</td>
                    <td class="px-4 py-3 font-mono text-blue-600">${record.membershipNo}</td>
                    <td class="px-4 py-3">
                        <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full font-semibold">
                            <i class="fas fa-users mr-1"></i>${record.familyCount}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-gray-600">
                        <i class="fas fa-clock mr-1"></i>${formatTime(record.timestamp)}
                    </td>
                </tr>
            `).join('');

            // Mobile card view
            mobileView.innerHTML = records.map((record, index) => `
                <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-4 border-l-4 border-green-500 shadow-sm">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-green-600 text-white text-xs font-bold px-2 py-1 rounded">
                                    #${index + 1}
                                </span>
                                <span class="text-xs text-gray-500">
                                    <i class="fas fa-clock mr-1"></i>${formatTime(record.timestamp)}
                                </span>
                            </div>
                            <div class="mb-2">
                                <p class="text-xs text-gray-600 mb-1">Membership Number</p>
                                <p class="font-mono text-lg font-bold text-blue-600">${record.membershipNo}</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between pt-2 border-t border-gray-200">
                        <span class="text-sm text-gray-600">Family Members</span>
                        <span class="bg-green-500 text-white px-4 py-2 rounded-full font-bold text-lg">
                            <i class="fas fa-users mr-1"></i>${record.familyCount}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // Check if membership already issued
        function checkDuplicate(membershipNo) {
            return records.find(r => r.membershipNo === membershipNo);
        }

        // Show family count modal
        function showFamilyCountModal(membershipNo) {
            const duplicate = checkDuplicate(membershipNo);
            
            if (duplicate) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Already Issued!',
                    html: `
                        <div class="text-left">
                            <p class="mb-2"><strong>Membership No:</strong> ${duplicate.membershipNo}</p>
                            <p class="mb-2"><strong>Family Count:</strong> ${duplicate.familyCount}</p>
                            <p class="mb-2"><strong>Time Issued:</strong> ${formatTime(duplicate.timestamp)}</p>
                        </div>
                    `,
                    confirmButtonColor: '#dc2626',
                    confirmButtonText: 'OK'
                });
                return;
            }

            // Create number buttons HTML with better styling
            const buttonsHtml = Array.from({length: 10}, (_, i) => i + 1).map(num => `
                <button class="number-btn bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-6 px-4 rounded-xl text-2xl transition-all duration-300" 
                        onclick="saveMember('${membershipNo}', ${num})">
                    ${num}
                </button>
            `).join('');

            Swal.fire({
                title: '<i class="fas fa-users text-green-600"></i> Select Family Members',
                html: `
                    <div class="text-center mb-6">
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4 rounded">
                            <p class="text-sm text-gray-600 mb-1">Membership Number</p>
                            <p class="text-xl font-mono font-bold text-blue-600">${membershipNo}</p>
                        </div>
                        <p class="text-gray-600 mb-4">
                            <i class="fas fa-hand-pointer text-green-500 mr-2"></i>
                            Tap the number of family members
                        </p>
                    </div>
                    <div class="grid grid-cols-5 gap-3 max-w-2xl mx-auto px-2">
                        ${buttonsHtml}
                    </div>
                `,
                showConfirmButton: false,
                showCancelButton: true,
                cancelButtonText: '<i class="fas fa-times mr-2"></i>Cancel',
                cancelButtonColor: '#6b7280',
                width: '700px',
                padding: '2em',
                customClass: {
                    popup: 'rounded-2xl',
                    title: 'text-2xl'
                }
            });
        }

        // Save member record
        window.saveMember = function(membershipNo, familyCount) {
            const record = {
                membershipNo,
                familyCount,
                timestamp: new Date().toISOString()
            };

            records.unshift(record);
            saveRecords();
            updateTable();

            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: `Distribution recorded for ${familyCount} family member(s)`,
                timer: 2000,
                showConfirmButton: false
            });

            document.getElementById('membershipInput').value = '';
        };

        // Start scanner
        document.getElementById('startScanBtn').addEventListener('click', function() {
            const readerDiv = document.getElementById('reader');
            
            if (isScanning) {
                html5QrCode.stop().then(() => {
                    readerDiv.classList.add('hidden');
                    isScanning = false;
                    this.innerHTML = '<i class="fas fa-camera mr-2"></i>Start Camera Scanner';
                    this.classList.remove('bg-red-600', 'hover:bg-red-700');
                    this.classList.add('bg-green-600', 'hover:bg-green-700');
                });
                return;
            }

            readerDiv.classList.remove('hidden');
            
            html5QrCode = new Html5Qrcode("reader");
            
            html5QrCode.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    formatsToSupport: [0] // 0 = QR_CODE only
                },
                (decodedText) => {
                    document.getElementById('membershipInput').value = decodedText;
                    showFamilyCountModal(decodedText);
                    
                    html5QrCode.stop().then(() => {
                        readerDiv.classList.add('hidden');
                        isScanning = false;
                        document.getElementById('startScanBtn').innerHTML = '<i class="fas fa-camera mr-2"></i>Start QR Code Scanner';
                        document.getElementById('startScanBtn').classList.remove('bg-red-600', 'hover:bg-red-700');
                        document.getElementById('startScanBtn').classList.add('bg-green-600', 'hover:bg-green-700');
                    });
                }
            ).then(() => {
                isScanning = true;
                this.innerHTML = '<i class="fas fa-stop mr-2"></i>Stop Scanner';
                this.classList.remove('bg-green-600', 'hover:bg-green-700');
                this.classList.add('bg-red-600', 'hover:bg-red-700');
            }).catch(err => {
                Swal.fire({
                    icon: 'error',
                    title: 'Camera Error',
                    text: 'Unable to access camera. Please check permissions.'
                });
                readerDiv.classList.add('hidden');
            });
        });

        // Manual submit
        document.getElementById('manualSubmitBtn').addEventListener('click', function() {
            const membershipNo = document.getElementById('membershipInput').value.trim();
            
            if (!membershipNo) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Please enter a membership number'
                });
                return;
            }

            showFamilyCountModal(membershipNo);
        });

        // Export to Excel
        document.getElementById('exportBtn').addEventListener('click', function() {
            if (records.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No Data',
                    text: 'No records to export'
                });
                return;
            }

            const exportData = records.map((record, index) => ({
                '#': index + 1,
                'Membership Number': record.membershipNo,
                'Family Members Count': record.familyCount,
                'Time Porridge Issued': formatTime(record.timestamp)
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Distribution Records");

            const today = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Porridge_Distribution_${today}.xlsx`);

            Swal.fire({
                icon: 'success',
                title: 'Exported!',
                text: 'Data exported successfully',
                timer: 2000,
                showConfirmButton: false
            });

            document.getElementById('resetBtn').classList.remove('hidden');
        });

        // Reset data
        document.getElementById('resetBtn').addEventListener('click', function() {
            Swal.fire({
                title: 'Are you sure?',
                text: "This will delete all distribution records!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Yes, reset it!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    records = [];
                    saveRecords();
                    updateTable();
                    this.classList.add('hidden');
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Reset Complete',
                        text: 'All records have been cleared',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
            });
        });

        // Initialize
        loadRecords();
    </script>
</body>
</html>